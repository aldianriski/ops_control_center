import { useQuery } from '@tanstack/react-query';
import { useAppStore } from '../store/appStore';
import {
  BarChart,
  Bar,
  PieChart,
  Pie,
  Cell,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
} from 'recharts';
import { TrendingUp, AlertTriangle, Shield, Activity } from 'lucide-react';

interface VulnerabilityStats {
  total_vulnerabilities: number;
  critical_count: number;
  high_count: number;
  medium_count: number;
  low_count: number;
  cvss_distribution: { score_range: string; count: number }[];
  severity_trend: { date: string; critical: number; high: number; medium: number; low: number }[];
  top_affected_assets: { hostname: string; vulnerability_count: number }[];
}

const VulnerabilityCharts = () => {
  const { selectedEnvironment } = useAppStore();

  // Mock data - replace with actual API call
  const { data: stats, isLoading } = useQuery({
    queryKey: ['vulnerability-stats', selectedEnvironment],
    queryFn: async (): Promise<VulnerabilityStats> => {
      // This would be a real API call in production
      return {
        total_vulnerabilities: 247,
        critical_count: 12,
        high_count: 45,
        medium_count: 98,
        low_count: 92,
        cvss_distribution: [
          { score_range: '0.0-2.0', count: 45 },
          { score_range: '2.1-4.0', count: 47 },
          { score_range: '4.1-6.0', count: 62 },
          { score_range: '6.1-8.0', count: 56 },
          { score_range: '8.1-10.0', count: 37 },
        ],
        severity_trend: [
          { date: 'Week 1', critical: 15, high: 52, medium: 87, low: 76 },
          { date: 'Week 2', critical: 14, high: 49, medium: 91, low: 81 },
          { date: 'Week 3', critical: 13, high: 47, medium: 95, low: 85 },
          { date: 'Week 4', critical: 12, high: 45, medium: 98, low: 92 },
        ],
        top_affected_assets: [
          { hostname: 'web-server-01', vulnerability_count: 23 },
          { hostname: 'db-primary-01', vulnerability_count: 19 },
          { hostname: 'api-gateway-02', vulnerability_count: 17 },
          { hostname: 'cache-redis-01', vulnerability_count: 15 },
          { hostname: 'worker-node-03', vulnerability_count: 12 },
        ],
      };
    },
  });

  const severityData = [
    { name: 'Critical', value: stats?.critical_count || 0, color: '#DC2626' },
    { name: 'High', value: stats?.high_count || 0, color: '#EA580C' },
    { name: 'Medium', value: stats?.medium_count || 0, color: '#D97706' },
    { name: 'Low', value: stats?.low_count || 0, color: '#65A30D' },
  ];

  const COLORS = {
    critical: '#DC2626',
    high: '#EA580C',
    medium: '#D97706',
    low: '#65A30D',
  };

  if (isLoading) {
    return (
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {[...Array(4)].map((_, i) => (
          <div key={i} className="bg-white rounded-lg shadow p-6 animate-pulse">
            <div className="h-64 bg-gray-200 rounded" />
          </div>
        ))}
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Summary Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div className="bg-gradient-to-br from-red-50 to-red-100 rounded-lg p-4 border border-red-200">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-red-700">Critical</p>
              <p className="text-2xl font-bold text-red-900 mt-1">{stats?.critical_count}</p>
            </div>
            <AlertTriangle size={24} className="text-red-600" />
          </div>
        </div>

        <div className="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4 border border-orange-200">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-orange-700">High</p>
              <p className="text-2xl font-bold text-orange-900 mt-1">{stats?.high_count}</p>
            </div>
            <TrendingUp size={24} className="text-orange-600" />
          </div>
        </div>

        <div className="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg p-4 border border-yellow-200">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-yellow-700">Medium</p>
              <p className="text-2xl font-bold text-yellow-900 mt-1">{stats?.medium_count}</p>
            </div>
            <Activity size={24} className="text-yellow-600" />
          </div>
        </div>

        <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm font-medium text-green-700">Low</p>
              <p className="text-2xl font-bold text-green-900 mt-1">{stats?.low_count}</p>
            </div>
            <Shield size={24} className="text-green-600" />
          </div>
        </div>
      </div>

      {/* Charts Grid */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* CVSS Score Distribution */}
        <div className="bg-white rounded-lg shadow p-6">
          <h3 className="text-lg font-semibold text-gray-900 mb-4">CVSS Score Distribution</h3>
          <ResponsiveContainer width="100%" height={300}>
            <BarChart data={stats?.cvss_distribution}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="score_range" />
              <YAxis />
              <Tooltip />
              <Legend />
              <Bar dataKey="count" fill="#3B82F6" name="Vulnerabilities" />
            </BarChart>
          </ResponsiveContainer>
        </div>

        {/* Severity Breakdown (Pie Chart) */}
        <div className="bg-white rounded-lg shadow p-6">
          <h3 className="text-lg font-semibold text-gray-900 mb-4">Severity Breakdown</h3>
          <ResponsiveContainer width="100%" height={300}>
            <PieChart>
              <Pie
                data={severityData}
                cx="50%"
                cy="50%"
                labelLine={false}
                label={({ name, value, percent }) =>
                  `${name}: ${value} (${(percent * 100).toFixed(0)}%)`
                }
                outerRadius={100}
                fill="#8884d8"
                dataKey="value"
              >
                {severityData.map((entry, index) => (
                  <Cell key={`cell-${index}`} fill={entry.color} />
                ))}
              </Pie>
              <Tooltip />
            </PieChart>
          </ResponsiveContainer>
        </div>

        {/* Severity Trend Over Time */}
        <div className="bg-white rounded-lg shadow p-6">
          <h3 className="text-lg font-semibold text-gray-900 mb-4">4-Week Trend</h3>
          <ResponsiveContainer width="100%" height={300}>
            <BarChart data={stats?.severity_trend}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="date" />
              <YAxis />
              <Tooltip />
              <Legend />
              <Bar dataKey="critical" stackId="a" fill={COLORS.critical} name="Critical" />
              <Bar dataKey="high" stackId="a" fill={COLORS.high} name="High" />
              <Bar dataKey="medium" stackId="a" fill={COLORS.medium} name="Medium" />
              <Bar dataKey="low" stackId="a" fill={COLORS.low} name="Low" />
            </BarChart>
          </ResponsiveContainer>
        </div>

        {/* Top Affected Assets */}
        <div className="bg-white rounded-lg shadow p-6">
          <h3 className="text-lg font-semibold text-gray-900 mb-4">Top Affected Assets</h3>
          <div className="space-y-3">
            {stats?.top_affected_assets.map((asset, index) => {
              const percentage = (asset.vulnerability_count / (stats?.total_vulnerabilities || 1)) * 100;
              return (
                <div key={asset.hostname}>
                  <div className="flex items-center justify-between mb-1">
                    <span className="text-sm font-medium text-gray-900">{asset.hostname}</span>
                    <span className="text-sm text-gray-600">{asset.vulnerability_count}</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-2">
                    <div
                      className="bg-blue-600 h-2 rounded-full transition-all"
                      style={{ width: `${percentage}%` }}
                    />
                  </div>
                </div>
              );
            })}
          </div>
          <div className="mt-4 pt-4 border-t border-gray-200">
            <div className="flex items-center justify-between text-sm">
              <span className="font-medium text-gray-700">Total Vulnerabilities</span>
              <span className="text-lg font-bold text-gray-900">{stats?.total_vulnerabilities}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default VulnerabilityCharts;
